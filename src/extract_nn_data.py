#!/usr/bin/python3

import pandas as pd
import functools

feature_list = ["string", "api", "dll"]
class_list = ["malware", "benign"]
csv_path = "../result/csv/similarity_vectors_%s_%s_%s.csv"

def main() :
    train_list = []
    test_list = []
    for class_name in class_list :
        a_class_list = []
        b_class_list = []
        for feature_name in feature_list :
            a_class_list.append(csv_path % (class_name, "train", feature_name))
            b_class_list.append(csv_path % (class_name, "test", feature_name))
        train_list.append(a_class_list)
        test_list.append(b_class_list)

    train_df_list = [load_df(data_set) for data_set in train_list]
    test_df_list = [load_df(data_set) for data_set in test_list]
    train_df = pd.concat(train_df_list)
    test_df = pd.concat(test_df_list)
    train_df.to_csv("./train_data.csv")
    test_df.to_csv("./test_data.csv")
    print("""
            num_input_column  => %d
            num_output_column => %d
    """ % (len(train_df.columns)-2, 2))

def load_csv(file_name) :
    if "malware" in file_name :
        label_malware = 1 #this means the corresponding file is malicious set
        label_benign = 0
    else :
        label_malware = 0
        label_benign = 1
    column_prefix = file_name.split("_")[-1].split(".")[0] + "_%d"
    df = pd.read_csv(file_name).set_index("file_name")
    df.columns = [column_prefix % i for i in range(len(df.columns))]
    df["label_malware"] = label_malware
    df["label_benign"] = label_benign
    return df

def load_df(file_list) :
    return simple_merge_df([load_csv(target_name) for target_name in file_list])


def simple_merge_df(df_list) :
    label_list = ["label_malware", "label_benign"]
    label_df = df_list[0][label_list]
    df_list = [df.drop(label_list, axis=1) for df in df_list]
    df_list.append(label_df)
    merged_df = functools.reduce(lambda x, y : x.join(y), df_list)
    return merged_df


main()
