import pefile
import sys
import os
import subprocess
import pefile

if len(sys.argv) != 2 :
    print("the number of arguments should be 2")
    exit(1)
if not os.path.exists("../resource/not_pe/") :
    os.mkdir("../resource/not_pe/")

path = sys.argv[1]
file_list = [path + f for f in os.listdir(path)]

for file_path in file_list :
    with open(file_path, mode="rb") as f :
        header = f.read(16)
        if header[:2] == b"\x4d\x5a" :
            try :
                pe = pefile.PE(file_path)
            except pefile.PEFormatError :
                print("\nis %s PE file?" % file_path)
                print("%-60s is not PE file.  file header => %30s" % (file_path, header))
                subprocess.call(["mv", file_path, "../resource/not_pe/"])
                continue
            if pe.OPTIONAL_HEADER.DATA_DIRECTORY[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_IMPORT']].VirtualAddress != 0:
                pe.parse_data_directories(directories=[pefile.DIRECTORY_ENTRY['IMAGE_DIRECTORY_ENTRY_IMPORT']])
                try :
                    pe.DIRECTORY_ENTRY_IMPORT
                except AttributeError :
                    print(file_path, "has no import table")
                    subprocess.call(["mv", file_path, "../resource/no_import_table/"])
        else :
            print("%-60s is not PE file.  file header => %30s" % (file_path, header))
            subprocess.call(["mv", file_path, "../resource/not_pe/"])

